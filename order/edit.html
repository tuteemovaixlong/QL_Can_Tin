{% extends "base.html" %}
{% block title %}Sửa Hóa Đơn #{{ order.MaHoaDon }}{% endblock %}
{% block content %}
<h2>Sửa Hóa Đơn #{{ order.MaHoaDon }}</h2>

<form method="POST" id="order-form" novalidate>
  <table class="table align-middle">
    <thead>
      <tr>
        <th>Tên Món Ăn</th>
        <th>Đơn Giá</th>
        <th style="width:160px">Số Lượng</th>
        <th>Thành tiền</th>
        <th style="width:90px">Thao tác</th>
      </tr>
    </thead>
    <tbody id="order-body">
      {% for dish in dishes %}
      {% set available = stock_map.get(dish.TenMonAn|lower) if stock_map else None %}
      {% set qty0 = prefill.get(dish.MaMonAn, 0) %}
      <tr>
        <td>
          {{ dish.TenMonAn }}
          {% if available is not none %}
            <div class="small text-muted">Tồn khả dụng: <span class="available">{{ available }}</span></div>
          {% endif %}
        </td>
        <td>
          <span class="unit-price" data-price="{{ dish.DonGia }}">{{ "{:,.0f}".format(dish.DonGia) }} VNĐ</span>
        </td>
        <td>
          <input type="number" name="quantity[]" class="form-control qty" value="{{ qty0 }}" min="0" step="1"
                 {% if available is not none %} max="{{ available + qty0 }}" {% endif %}>
          <input type="hidden" name="item_id[]" value="{{ dish.MaMonAn }}">
        </td>
        <td class="subtotal">0 VNĐ</td>
        <td>
          <button type="button" class="btn btn-sm btn-outline-danger remove-row">Xóa</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <th colspan="3" class="text-end">Tổng cộng:</th>
        <th id="grand-total">0 VNĐ</th>
        <th></th>
      </tr>
    </tfoot>
  </table>

  <button type="submit" class="btn btn-primary" id="save-btn">Lưu thay đổi</button>
  <a href="{{ url_for('order.view_order', order_id=order.MaHoaDon) }}" class="btn btn-secondary">Hủy</a>
</form>

<script>
(function() {
  const fmt = n => (Number(n)||0).toLocaleString('vi-VN') + ' VNĐ';
  const tbody = document.getElementById('order-body');
  const totalEl = document.getElementById('grand-total');

  function recalc() {
    let total = 0;
    tbody.querySelectorAll('tr').forEach(tr => {
      const price = Number(tr.querySelector('.unit-price').dataset.price);
      const qtyEl = tr.querySelector('.qty');
      const qty = Number(qtyEl.value) || 0;
      const sub = price * qty;
      tr.querySelector('.subtotal').textContent = fmt(sub);
      total += sub;
    });
    totalEl.textContent = fmt(total);
  }

  tbody.addEventListener('click', (e) => {
    if (e.target.classList.contains('remove-row')) {
      const tr = e.target.closest('tr');
      const qtyEl = tr.querySelector('.qty');
      qtyEl.value = 0;
      tr.classList.add('table-active'); // đánh dấu
      recalc();
    }
  });

  tbody.addEventListener('input', (e) => {
    if (e.target.classList.contains('qty')) recalc();
  });

  recalc();
})();
</script>
{% endblock %}
