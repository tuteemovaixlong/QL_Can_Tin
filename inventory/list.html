{% extends "base.html" %}
{% block title %}Quản lý Kho hàng{% endblock %}

{% block content %}
{# === THAM SỐ CẢNH BÁO (DỄ CHỈNH) === #}
{% set HIGH_MULT = 2 %}    {# Dư khi >= HIGH_MULT × ngưỡng (vd: 2 = x2) #}
{% set HIGH_OFFSET = 0 %}  {# Hoặc dư khi >= ngưỡng + HIGH_OFFSET #}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Tồn Kho</h2>
  <a href="{{ url_for('inventory.import_item') }}" class="btn btn-primary">Nhập hàng mới</a>
</div>

<!-- Legend trạng thái -->
<div class="mb-3">
  <span class="badge text-bg-danger">Thiếu (≤ ngưỡng)</span>
  <span class="badge text-bg-warning ms-2">Dư (≥ max( {{ HIGH_MULT }}× ngưỡng, ngưỡng + {{ HIGH_OFFSET }} ))</span>
  <span class="badge text-bg-secondary ms-2">Ổn định</span>
</div>

{% if items %}
<table class="table table-striped align-middle">
  <thead>
    <tr>
      <th style="position:sticky;top:0;background:#fff;z-index:1;">Mã Hàng</th>
      <th style="position:sticky;top:0;background:#fff;z-index:1;">Tên Hàng Hóa</th>
      <th style="position:sticky;top:0;background:#fff;z-index:1;">Số Lượng Tồn</th>
      <th style="position:sticky;top:0;background:#fff;z-index:1;">Đơn Vị Tính</th>
      <th style="position:sticky;top:0;background:#fff;z-index:1;">Ngưỡng Cảnh Báo</th>
      <th style="position:sticky;top:0;background:#fff;z-index:1;">Cập nhật cuối</th>
      <th style="position:sticky;top:0;background:#fff;z-index:1;">Hành động</th>
    </tr>
  </thead>
  <tbody>
    {% for item in items %}
    {% set is_low  = (item.SoLuongTon <= item.NguongCanhBao) %}
    {% set high_cut = (item.NguongCanhBao * HIGH_MULT) if item.NguongCanhBao else 9999999 %}
    {% set high_alt = (item.NguongCanhBao + HIGH_OFFSET) %}
    {% set high_thr = high_cut if high_cut > high_alt else high_alt %}
    {% set is_high = (item.SoLuongTon >= high_thr) %}
    <tr class="{% if is_low %}table-danger{% elif is_high %}table-warning{% endif %}">
      <td>{{ item.MaHang }}</td>
      <td>{{ item.TenHang }}</td>
      <td>
        {{ item.SoLuongTon }}
        {% if is_low %}
          <span class="badge text-bg-danger ms-2">Thiếu</span>
        {% elif is_high %}
          <span class="badge text-bg-warning ms-2">Dư</span>
        {% else %}
          <span class="badge text-bg-secondary ms-2">Ổn</span>
        {% endif %}
      </td>
      <td>{{ item.DonViTinh }}</td>
      <td>{{ item.NguongCanhBao }}</td>
      <td>
        {% if item.ThoiGianCapNhatCuoi %}
          {{ item.ThoiGianCapNhatCuoi.strftime('%d-%m-%Y %H:%M') }}
        {% else %}—{% endif %}
      </td>
      <td>
        <a href="{{ url_for('inventory.adjust_item', item_id=item.MaHang) }}"
           class="btn btn-sm btn-warning">Điều chỉnh / Xuất</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<div class="alert alert-info">
  Chưa có dữ liệu kho. Hãy <a href="{{ url_for('inventory.import_item') }}" class="alert-link">nhập hàng mới</a>.
</div>
{% endif %}
{% endblock %}
